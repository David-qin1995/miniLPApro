# 🐳 Docker 镜像部署方案

## 📋 目录

- [方案优势](#方案优势)
- [工作流程](#工作流程)
- [本地构建和推送](#本地构建和推送)
- [服务器拉取和部署](#服务器拉取和部署)
- [镜像仓库选择](#镜像仓库选择)
- [版本管理](#版本管理)

---

## 🎯 方案优势

### ✅ vs 服务器构建

| 特性 | 本地构建+镜像部署 | 服务器构建 |
|------|-----------------|-----------|
| **构建速度** | ✅ 快（本地资源好） | ❌ 慢（服务器资源有限） |
| **服务器资源** | ✅ 节省（只拉取） | ❌ 消耗（需要构建） |
| **网络问题** | ✅ 无（本地网络好） | ❌ 容易卡住（npm 安装） |
| **部署速度** | ✅ 秒级（拉取即可） | ❌ 分钟级（需要构建） |
| **版本管理** | ✅ 清晰（tag 管理） | ❌ 难以管理 |
| **回滚速度** | ✅ 秒级 | ❌ 需要重新构建 |
| **预测试** | ✅ 可以本地测试 | ❌ 无法预测试 |

---

## 🔄 工作流程

```
本地开发环境
    ↓
本地构建镜像 (build-and-push.sh)
    ↓
推送到 Docker Hub / 阿里云镜像仓库
    ↓
服务器拉取镜像 (docker-pull-deploy.sh)
    ↓
运行容器 (docker-compose.image.yml)
    ↓
完成部署 ✅
```

---

## 🏗️ 本地构建和推送

### 前置要求

1. **安装 Docker Desktop**（本地）
2. **Docker Hub 账号**（或阿里云镜像仓库账号）
3. **登录 Docker Hub**

```bash
docker login
# 输入用户名和密码
```

### 步骤 1: 构建镜像

```bash
cd /Users/jason/devTools/code/miniplapro/minilpa-web

# 方式一：使用脚本（推荐）
bash build-and-push.sh

# 方式二：指定版本号
bash build-and-push.sh v1.0.0

# 方式三：手动构建
docker build -t davidqin1995/minilpa-web:latest .
```

### 步骤 2: 测试镜像

```bash
# 本地测试运行
docker run -d -p 3001:3000 --name minilpa-test davidqin1995/minilpa-web:latest

# 测试健康检查
curl http://localhost:3001/api/health

# 停止测试容器
docker stop minilpa-test
docker rm minilpa-test
```

### 步骤 3: 推送镜像

```bash
# 使用脚本（自动推送）
bash build-and-push.sh

# 或手动推送
docker push davidqin1995/minilpa-web:latest
docker push davidqin1995/minilpa-web:v1.0.0
```

---

## 🚀 服务器拉取和部署

### 步骤 1: 准备环境

```bash
# SSH 登录服务器
ssh root@your-server-ip

# 安装 Docker
curl -fsSL https://get.docker.com | bash -
systemctl start docker
systemctl enable docker

# 安装 docker-compose（如果未安装）
# 或使用 docker compose（Docker 20.10+ 内置）
```

### 步骤 2: 获取项目代码

```bash
cd /www/wwwroot
git clone https://github.com/David-qin1995/miniLPApro.git temp-minilpa
mv temp-minilpa/minilpa-web minilpa-web
rm -rf temp-minilpa
cd minilpa-web
```

### 步骤 3: 配置环境变量

```bash
# 复制环境变量模板
cp env.esim.haoyiseo.com .env

# 编辑配置（如果需要）
vim .env
```

### 步骤 4: 一键部署

```bash
# 使用部署脚本（推荐）
bash docker-pull-deploy.sh

# 或指定版本
bash docker-pull-deploy.sh v1.0.0
```

脚本会自动完成：
- ✅ 拉取最新镜像
- ✅ 停止旧容器
- ✅ 启动新容器
- ✅ 健康检查
- ✅ 状态验证

---

## 🏪 镜像仓库选择

### 方案一：Docker Hub（推荐）⭐⭐⭐⭐⭐

**优点**：
- ✅ 全球CDN，速度快
- ✅ 免费使用（公开仓库）
- ✅ 使用简单

**配置**：
```bash
IMAGE_NAME="davidqin1995/minilpa-web"
```

**登录**：
```bash
docker login
```

---

### 方案二：阿里云容器镜像服务（国内推荐）⭐⭐⭐⭐⭐

**优点**：
- ✅ 国内访问速度快
- ✅ 免费使用（有额度限制）
- ✅ 支持私有仓库

**配置**：

1. 创建命名空间和仓库
   - 访问：https://cr.console.aliyun.com/
   - 创建命名空间（如：minilpa）
   - 创建镜像仓库（如：minilpa-web）

2. 修改配置
   ```bash
   IMAGE_NAME="registry.cn-hangzhou.aliyuncs.com/minilpa/minilpa-web"
   ```

3. 登录
   ```bash
   docker login --username=your-username registry.cn-hangzhou.aliyuncs.com
   ```

---

### 方案三：腾讯云容器镜像服务

**优点**：
- ✅ 国内访问快
- ✅ 与腾讯云服务集成好

**配置**：
```bash
IMAGE_NAME="ccr.ccs.tencentyun.com/your-namespace/minilpa-web"
```

---

## 🏷️ 版本管理

### 标签策略

```bash
# 使用语义化版本号
docker tag minilpa-web davidqin1995/minilpa-web:v1.0.0
docker tag minilpa-web davidqin1995/minilpa-web:latest

# 推送版本
docker push davidqin1995/minilpa-web:v1.0.0
docker push davidqin1995/minilpa-web:latest
```

### 版本推荐

- `latest` - 最新稳定版
- `v1.0.0` - 具体版本号
- `v1.0.0-beta` - 测试版本
- `2023-10-31` - 日期版本

---

## 📝 完整示例

### 本地构建和推送

```bash
# 1. 进入项目目录
cd /Users/jason/devTools/code/miniplapro/minilpa-web

# 2. 登录 Docker Hub
docker login

# 3. 构建并推送（自动）
bash build-and-push.sh v1.0.0

# 或手动操作：
docker build -t davidqin1995/minilpa-web:v1.0.0 .
docker tag davidqin1995/minilpa-web:v1.0.0 davidqin1995/minilpa-web:latest
docker push davidqin1995/minilpa-web:v1.0.0
docker push davidqin1995/minilpa-web:latest
```

### 服务器部署

```bash
# 1. SSH 登录服务器
ssh root@your-server-ip

# 2. 进入项目目录
cd /www/wwwroot/minilpa-web

# 3. 配置环境变量
cp env.esim.haoyiseo.com .env

# 4. 一键部署
bash docker-pull-deploy.sh

# 或指定版本
bash docker-pull-deploy.sh v1.0.0
```

---

## 🔧 高级用法

### 多环境部署

```bash
# 生产环境
docker-pull-deploy.sh v1.0.0

# 测试环境
docker-pull-deploy.sh v1.0.0-beta
```

### 回滚到旧版本

```bash
# 直接指定旧版本号
bash docker-pull-deploy.sh v0.9.0
```

### 查看镜像列表

```bash
# Docker Hub
curl https://hub.docker.com/v2/repositories/davidqin1995/minilpa-web/tags

# 本地
docker images | grep minilpa-web
```

---

## ✅ 优势总结

### 🚀 部署速度

- **本地构建**: 2-5 分钟（根据网络）
- **服务器拉取**: 30 秒 - 2 分钟（根据镜像大小）
- **总计**: 3-7 分钟完成部署

vs **服务器构建**: 10-30 分钟（甚至更久）

### 💰 资源节省

- **服务器 CPU**: 只用于运行，不用于构建
- **服务器内存**: 运行需要 ~512MB，构建需要 ~2GB
- **服务器带宽**: 只拉取镜像，不需要下载大量 npm 包

### 🔒 可靠性

- ✅ 本地构建可以充分测试
- ✅ 避免服务器网络问题
- ✅ 版本管理清晰
- ✅ 回滚速度快

---

## 📊 对比总结

| 项目 | 本地构建+镜像 | 服务器构建 |
|------|-------------|-----------|
| **构建时间** | 3-5 分钟 | 10-30 分钟 |
| **服务器资源** | 低（只运行） | 高（构建+运行） |
| **网络依赖** | 构建时（本地好） | 构建时（服务器可能差） |
| **部署速度** | 快（拉取即可） | 慢（需要构建） |
| **版本管理** | ✅ 清晰 | ❌ 难以管理 |
| **回滚** | ✅ 秒级 | ❌ 需要重建 |
| **推荐度** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |

---

## 🎉 推荐使用镜像部署方案！

**优势明显，部署更快，资源更省，管理更简单！** 🚀

