# 🎉 宝塔 CentOS 7 部署方案已完成！

## ✅ 已为您准备好

### 📁 部署文件

| 文件 | 说明 | 用途 |
|------|------|------|
| **宝塔部署指南.md** | 详细部署文档 | 完整的部署步骤，包含所有细节 |
| **scripts/baota-deploy.sh** | 一键部署脚本 | 自动化部署，一条命令完成 |
| **快速部署到宝塔.txt** | 快速参考 | 最简化的部署指引 |
| **部署命令清单.sh** | 命令清单 | 所有部署命令的集合 |
| **宝塔部署完成.md** | 部署总结 | 部署方案说明 |

---

## 🚀 部署路径（已配置）

```
/www/wwwroot/minilpa
```

所有配置文件和脚本都已按此路径配置完成！

---

## ⚡ 最快部署方式

### 在您的 CentOS 7 服务器上执行：

```bash
# 1. SSH 登录
ssh root@your-server-ip

# 2. 进入宝塔目录并克隆项目
cd /www/wwwroot
git clone https://github.com/David-qin1995/miniLPApro.git temp-minilpa
mv temp-minilpa/minilpa-web minilpa-web
rm -rf temp-minilpa

# 3. 一键部署
cd minilpa-web
bash 一键部署到esim.haoyiseo.com.sh
```

### 🎊 完成！

脚本会自动完成：
- ✅ 检查环境
- ✅ 安装依赖
- ✅ 配置环境变量
- ✅ 构建前端
- ✅ 设置权限
- ✅ 配置 PM2
- ✅ 配置 Nginx
- ✅ 启动服务

---

## 📋 部署前准备

### 服务器要求

- ✅ CentOS 7
- ✅ 已安装宝塔面板
- ✅ 至少 1GB 内存
- ✅ 至少 10GB 磁盘

### 宝塔面板需安装

- ✅ Nginx (推荐最新版)
- ✅ PM2 管理器
- ✅ Node.js (v16 或 v18)

---

## 📖 文档说明

### 1. 宝塔部署指南.md ⭐⭐⭐⭐⭐

**最详细的部署文档**

包含内容：
- 完整部署步骤（8个步骤）
- 两种部署方式（自动/手动）
- Nginx 配置详解
- PM2 配置详解
- 环境变量配置
- SSL 证书配置
- 故障排查指南
- 安全建议
- 监控和维护

**推荐：** 第一次部署必读

### 2. scripts/baota-deploy.sh ⭐⭐⭐⭐⭐

**一键自动部署脚本**

功能：
- ✅ 自动检查环境
- ✅ 安装所有依赖
- ✅ 生成配置文件
- ✅ 构建前端
- ✅ 配置服务
- ✅ 验证部署
- ✅ 输出彩色日志

**推荐：** 最快捷的部署方式

### 3. 快速部署到宝塔.txt ⭐⭐⭐⭐

**快速参考指南**

特点：
- 简洁明了
- 核心命令
- 常见问题
- 快速排错

**推荐：** 部署时快速查阅

### 4. 部署命令清单.sh ⭐⭐⭐

**所有命令的集合**

内容：
- 部署命令
- 管理命令
- 维护命令
- 更新命令

**推荐：** 命令参考手册

---

## 🎯 部署流程

```
准备服务器
    ↓
安装宝塔面板
    ↓
安装 Nginx + PM2 + Node.js
    ↓
上传项目到 /www/wwwroot/minilpa
    ↓
执行: bash scripts/baota-deploy.sh
    ↓
修改域名配置
    ↓
配置 SSL（可选）
    ↓
✅ 部署完成！
```

---

## ⚙️ 部署后配置

### 必须修改

1. **域名配置**

编辑 `.env`：
```bash
vim /www/wwwroot/minilpa/.env
```

修改：
```
CORS_ORIGIN=https://your-actual-domain.com
```

2. **Nginx 域名**

```bash
vim /www/server/panel/vhost/nginx/minilpa.conf
```

修改：
```
server_name your-actual-domain.com;
```

重载：
```bash
nginx -s reload
```

### 推荐配置

3. **SSL 证书**

在宝塔面板中：
- 网站 → 设置 → SSL
- 申请 Let's Encrypt 证书
- 开启强制 HTTPS

---

## ✅ 验证部署

### 1. 检查服务

```bash
# PM2 状态
pm2 status
# 应该看到 minilpa 在运行

# 后端测试
curl http://localhost:3000/api/health
# 应该返回: {"status":"ok",...}
```

### 2. 浏览器访问

打开：`http://your-domain.com`

应该看到 MiniLPA Web 界面

---

## 📊 目录结构（部署后）

```
/www/wwwroot/minilpa/
├── client/
│   └── dist/              ← Nginx 访问此目录
├── server/
│   ├── index.js           ← PM2 运行此文件
│   ├── routes/
│   └── lpac/
├── data/                  ← 数据库文件
├── uploads/               ← 上传文件
├── logs/                  ← 日志文件
├── .env                   ← 环境变量（重要！）
├── ecosystem.config.js    ← PM2 配置
└── scripts/
    └── baota-deploy.sh    ← 部署脚本
```

---

## 🔄 常用命令

### 查看状态

```bash
pm2 status
```

### 查看日志

```bash
pm2 logs minilpa
tail -f /www/wwwroot/minilpa/logs/nginx-access.log
```

### 重启服务

```bash
pm2 restart minilpa
nginx -s reload
```

### 更新应用

```bash
cd /www/wwwroot/minilpa
git pull
npm install && cd client && npm install && cd ..
npm run build
pm2 restart minilpa
```

### 备份数据

```bash
tar -czf ~/minilpa-backup-$(date +%Y%m%d).tar.gz \
  /www/wwwroot/minilpa/data \
  /www/wwwroot/minilpa/uploads
```

---

## ❌ 常见问题

### 问题 1: PM2 无法启动

**解决：**
```bash
pm2 logs minilpa --err
# 查看错误信息

lsof -i:3000
# 检查端口占用

node server/index.js
# 手动测试
```

### 问题 2: Nginx 502 错误

**原因：** 后端未运行

**解决：**
```bash
pm2 status
pm2 restart minilpa
curl http://localhost:3000/api/health
```

### 问题 3: 页面空白

**原因：** 前端未构建

**解决：**
```bash
cd /www/wwwroot/minilpa
npm run build
ls -la client/dist/
```

### 问题 4: 权限错误

**解决：**
```bash
chown -R www:www /www/wwwroot/minilpa
chmod -R 755 /www/wwwroot/minilpa
```

---

## 🔒 安全检查清单

部署后请确认：

- □ 已修改 SESSION_SECRET（随机字符串）
- □ 已配置正确的域名（CORS_ORIGIN）
- □ 已配置 SSL 证书（HTTPS）
- □ 已配置防火墙（只开放 80/443）
- □ 目录权限正确（www:www）
- □ 已设置定期备份

---

## 📞 获取帮助

### 文档

- 📖 宝塔部署指南.md - 详细步骤
- ⚡ 快速部署到宝塔.txt - 快速参考
- 📋 部署命令清单.sh - 命令参考

### 问题排查

1. 查看日志文件
2. 检查服务状态
3. 参考故障排查章节
4. 提交 Issue

---

## 🎉 总结

### ✅ 已完成

- 完整的部署文档（4个文件）
- 自动化部署脚本
- 部署路径配置（/www/wwwroot/minilpa）
- Nginx 配置模板
- PM2 配置文件
- 环境变量模板
- 故障排查指南
- 安全建议

### 🚀 部署优势

- **快速** - 一条命令完成部署
- **自动化** - 脚本自动配置所有服务
- **安全** - 包含安全配置建议
- **完整** - 文档详尽，易于维护
- **灵活** - 支持自动和手动两种方式

### 📊 部署时间

- 自动部署：**约 5-10 分钟**
- 手动部署：**约 15-30 分钟**

---

## 🎯 下一步

### 立即部署

1. 准备服务器（CentOS 7 + 宝塔）
2. 上传项目到 `/www/wwwroot/minilpa`
3. 执行 `bash scripts/baota-deploy.sh`
4. 修改域名配置
5. 配置 SSL
6. 完成！

### 项目上线后

1. 定期备份数据
2. 监控服务状态
3. 定期更新系统
4. 查看访问日志
5. 优化性能

---

## 💡 提示

### 本地测试

部署前建议在本地测试：
```bash
cd /Users/jason/devTools/code/miniplapro/minilpa-web
npm run dev
```

### lpac 功能

- 默认使用模拟模式
- 如需真实 lpac，查看 `LPAC配置说明.md`

### 域名配置

- 确保域名已解析到服务器 IP
- 修改 `.env` 和 Nginx 配置中的域名
- 配置 SSL 证书

---

**所有准备工作已完成！现在就可以开始部署了！** 🚀

有任何问题随时查看文档或询问！

═══════════════════════════════════════════════════════════════

**祝部署顺利！** 🎊

