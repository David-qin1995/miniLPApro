# ğŸ“– å®å¡” Nginx é…ç½®è¯´æ˜

## ğŸ“‹ ç›®å½•

- [ä¸¤ç§éƒ¨ç½²æ–¹å¼](#ä¸¤ç§éƒ¨ç½²æ–¹å¼)
- [é…ç½®å¯¹æ¯”](#é…ç½®å¯¹æ¯”)
- [ä½¿ç”¨è¯´æ˜](#ä½¿ç”¨è¯´æ˜)
- [é…ç½®æ­¥éª¤](#é…ç½®æ­¥éª¤)

---

## ğŸ¯ ä¸¤ç§éƒ¨ç½²æ–¹å¼

### æ–¹å¼ä¸€ï¼šä¼ ç»Ÿéƒ¨ç½²ï¼ˆPM2ï¼‰

- **åç«¯**: Node.js + Express è¿è¡Œåœ¨ç«¯å£ **3000**
- **å‰ç«¯**: é™æ€æ–‡ä»¶åœ¨ `/www/wwwroot/minilpa-web/client/dist`
- **Nginx**: åå‘ä»£ç†åç«¯ APIï¼Œç›´æ¥æä¾›å‰ç«¯é™æ€æ–‡ä»¶

**é…ç½®æ–‡ä»¶**: `nginx-baota-traditional.conf`

---

### æ–¹å¼äºŒï¼šDocker éƒ¨ç½²ï¼ˆæ¨èï¼‰ğŸ³

- **æ‰€æœ‰æœåŠ¡**: è¿è¡Œåœ¨ Docker å®¹å™¨å†…
- **å®¹å™¨ç«¯å£**: 80ï¼ˆç”± docker-compose ç®¡ç†ï¼‰
- **Nginx**: åªåšä¸€å±‚åå‘ä»£ç†åˆ° Docker å®¹å™¨

**é…ç½®æ–‡ä»¶**: `nginx-baota-docker.conf`

---

## ğŸ“Š é…ç½®å¯¹æ¯”

| ç‰¹æ€§ | ä¼ ç»Ÿéƒ¨ç½² | Docker éƒ¨ç½² |
|------|---------|------------|
| åç«¯ç«¯å£ | 3000 | 80ï¼ˆå®¹å™¨å†…ï¼‰ |
| å‰ç«¯è·¯å¾„ | `/www/wwwroot/minilpa-web/client/dist` | å®¹å™¨å†…ï¼ˆç”± Docker Nginx å¤„ç†ï¼‰ |
| é…ç½®å¤æ‚åº¦ | â­â­â­ | â­â­ |
| ç¯å¢ƒéš”ç¦» | âŒ | âœ… |
| æ¨èåº¦ | â­â­â­ | â­â­â­â­â­ |

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### æ–¹å¼ä¸€ï¼šä¼ ç»Ÿéƒ¨ç½²é…ç½®

#### 1. å¤åˆ¶é…ç½®æ–‡ä»¶

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /www/wwwroot/minilpa-web
cp nginx-baota-traditional.conf /www/server/panel/vhost/nginx/esim.haoyiseo.com.conf
```

#### 2. ä¿®æ”¹å®å¡”é¢æ¿é…ç½®

1. ç™»å½•**å®å¡”é¢æ¿**
2. è¿›å…¥ **ç½‘ç«™** â†’ æ‰¾åˆ° `esim.haoyiseo.com`
3. ç‚¹å‡» **è®¾ç½®** â†’ **é…ç½®æ–‡ä»¶**
4. ç²˜è´´ `nginx-baota-traditional.conf` çš„å†…å®¹
5. ç‚¹å‡» **ä¿å­˜**

#### 3. æµ‹è¯•é…ç½®

```bash
# æµ‹è¯• Nginx é…ç½®
nginx -t

# é‡è½½é…ç½®
nginx -s reload
```

#### 4. é…ç½®è¦ç‚¹

- âœ… **åç«¯ç«¯å£**: `http://127.0.0.1:3000`
- âœ… **å‰ç«¯è·¯å¾„**: `/www/wwwroot/minilpa-web/client/dist`
- âœ… **API ä»£ç†**: `/api/` â†’ åç«¯
- âœ… **é™æ€æ–‡ä»¶**: ç›´æ¥ç”± Nginx æä¾›

---

### æ–¹å¼äºŒï¼šDocker éƒ¨ç½²é…ç½®

#### 1. ä¿®æ”¹ docker-compose.yml

å¦‚æœä½¿ç”¨ Docker éƒ¨ç½²ï¼Œéœ€è¦ç¡®ä¿å®¹å™¨ç«¯å£æ˜ å°„æ­£ç¡®ï¼š

```yaml
services:
  nginx:
    ports:
      - "8080:80"  # æ˜ å°„åˆ° 8080ï¼ˆé¿å…ä¸å®å¡” Nginx å†²çªï¼‰
```

#### 2. å¤åˆ¶é…ç½®æ–‡ä»¶

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /www/wwwroot/minilpa-web
cp nginx-baota-docker.conf /www/server/panel/vhost/nginx/esim.haoyiseo.com.conf
```

#### 3. ä¿®æ”¹ä»£ç†ç«¯å£

ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œå°† `proxy_pass http://127.0.0.1:80;` æ”¹ä¸ºï¼š

```nginx
proxy_pass http://127.0.0.1:8080;  # ä¸ docker-compose.yml ä¸­çš„ç«¯å£ä¸€è‡´
```

#### 4. åœ¨å®å¡”é¢æ¿ä¸­é…ç½®

1. ç™»å½•**å®å¡”é¢æ¿**
2. è¿›å…¥ **ç½‘ç«™** â†’ æ‰¾åˆ° `esim.haoyiseo.com`
3. ç‚¹å‡» **è®¾ç½®** â†’ **é…ç½®æ–‡ä»¶**
4. ç²˜è´´ä¿®æ”¹åçš„é…ç½®å†…å®¹
5. ç‚¹å‡» **ä¿å­˜**

---

## ğŸ”§ é…ç½®æ­¥éª¤

### æ­¥éª¤ 1ï¼šé€‰æ‹©éƒ¨ç½²æ–¹å¼

- **æ¨è**: Docker éƒ¨ç½²ï¼ˆè§£å†³ç¯å¢ƒé—®é¢˜ï¼‰
- **å¤‡é€‰**: ä¼ ç»Ÿéƒ¨ç½²ï¼ˆéœ€è¦æ‰‹åŠ¨å®‰è£… Node.jsã€PM2ï¼‰

### æ­¥éª¤ 2ï¼šå‡†å¤‡é…ç½®æ–‡ä»¶

```bash
# ä¼ ç»Ÿéƒ¨ç½²
cd /www/wwwroot/minilpa-web
cat nginx-baota-traditional.conf

# Docker éƒ¨ç½²
cat nginx-baota-docker.conf
```

### æ­¥éª¤ 3ï¼šåœ¨å®å¡”é¢æ¿ä¸­åº”ç”¨

1. **ç™»å½•å®å¡”é¢æ¿**
2. **ç½‘ç«™** â†’ æ‰¾åˆ° `esim.haoyiseo.com`
3. **è®¾ç½®** â†’ **é…ç½®æ–‡ä»¶**
4. **æ¸…ç©ºç°æœ‰å†…å®¹** â†’ **ç²˜è´´æ–°é…ç½®** â†’ **ä¿å­˜**

### æ­¥éª¤ 4ï¼šéªŒè¯é…ç½®

```bash
# æµ‹è¯• Nginx é…ç½®è¯­æ³•
nginx -t

# å¦‚æœæˆåŠŸï¼Œé‡è½½é…ç½®
nginx -s reload

# æˆ–ä½¿ç”¨å®å¡”é¢æ¿
# ç½‘ç«™ â†’ è®¾ç½® â†’ é…ç½®æ–‡ä»¶ â†’ æµ‹è¯• â†’ ä¿å­˜
```

### æ­¥éª¤ 5ï¼šæµ‹è¯•è®¿é—®

```bash
# æµ‹è¯•åç«¯
curl http://localhost:3000/api/health  # ä¼ ç»Ÿéƒ¨ç½²
curl http://localhost:8080/api/health  # Docker éƒ¨ç½²

# æµ‹è¯•å‰ç«¯
curl http://localhost/

# æµ‹è¯•åŸŸå
curl http://esim.haoyiseo.com/api/health
```

---

## ğŸ” é…ç½®è¯¦è§£

### ä¼ ç»Ÿéƒ¨ç½²é…ç½®è¦ç‚¹

```nginx
# 1. å‰ç«¯é™æ€æ–‡ä»¶ç›®å½•
root /www/wwwroot/minilpa-web/client/dist;

# 2. åç«¯ API ä»£ç†
location /api/ {
    proxy_pass http://127.0.0.1:3000;
}

# 3. Vue Router æ”¯æŒ
location / {
    try_files $uri $uri/ /index.html;
}
```

### Docker éƒ¨ç½²é…ç½®è¦ç‚¹

```nginx
# æ‰€æœ‰è¯·æ±‚ä»£ç†åˆ° Docker å®¹å™¨
location / {
    proxy_pass http://127.0.0.1:8080;  # ä¸ docker-compose.yml ç«¯å£ä¸€è‡´
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç«¯å£å†²çª

- **ä¼ ç»Ÿéƒ¨ç½²**: ç¡®ä¿åç«¯è¿è¡Œåœ¨ç«¯å£ **3000**
- **Docker éƒ¨ç½²**: ç¡®ä¿å®¹å™¨æ˜ å°„åˆ°ç«¯å£ **8080**ï¼ˆæˆ–å…¶ä»–é 80 ç«¯å£ï¼‰

### 2. è·¯å¾„é—®é¢˜

- **ä¼ ç»Ÿéƒ¨ç½²**: å‰ç«¯è·¯å¾„å¿…é¡»æ˜¯ `/www/wwwroot/minilpa-web/client/dist`
- **Docker éƒ¨ç½²**: å‰ç«¯è·¯å¾„ä¸éœ€è¦é…ç½®ï¼Œç”±å®¹å™¨å¤„ç†

### 3. SSL è¯ä¹¦

ç”³è¯· SSL è¯ä¹¦åï¼Œå®å¡”ä¼šè‡ªåŠ¨æ·»åŠ  HTTPS é…ç½®ï¼Œæ— éœ€æ‰‹åŠ¨ä¿®æ”¹ã€‚

### 4. WebSocketï¼ˆå¦‚æœéœ€è¦ï¼‰

å¦‚æœé¡¹ç›®éœ€è¦ WebSocketï¼Œåœ¨é…ç½®ä¸­æ·»åŠ ï¼š

```nginx
location /ws {
    proxy_pass http://127.0.0.1:3000;  # æˆ– 8080ï¼ˆDockerï¼‰
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
```

---

## ğŸš€ æ¨èé…ç½®

### æ–¹æ¡ˆä¸€ï¼šDocker éƒ¨ç½²ï¼ˆæ¨èï¼‰â­â­â­â­â­

**ä¼˜ç‚¹**ï¼š
- âœ… ç¯å¢ƒä¸€è‡´æ€§å¥½
- âœ… é…ç½®ç®€å•ï¼ˆåªéœ€ä¸€å±‚ä»£ç†ï¼‰
- âœ… æ˜“äºç»´æŠ¤å’Œå‡çº§

**é…ç½®**ï¼š
```bash
# 1. ä½¿ç”¨ Docker éƒ¨ç½²
bash docker-deploy.sh

# 2. ä¿®æ”¹ docker-compose.ymlï¼Œå°† Nginx ç«¯å£æ”¹ä¸º 8080
ports:
  - "8080:80"

# 3. ä½¿ç”¨ nginx-baota-docker.conf é…ç½®
```

### æ–¹æ¡ˆäºŒï¼šä¼ ç»Ÿéƒ¨ç½²

**ä¼˜ç‚¹**ï¼š
- âœ… ç›´æ¥è®¿é—®é™æ€æ–‡ä»¶ï¼ˆæ€§èƒ½å¥½ï¼‰
- âœ… å¯ä»¥å•ç‹¬ä¼˜åŒ–é™æ€æ–‡ä»¶ç¼“å­˜

**é…ç½®**ï¼š
```bash
# 1. ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼éƒ¨ç½²
bash ä¸€é”®éƒ¨ç½²åˆ°esim.haoyiseo.com.sh

# 2. ä½¿ç”¨ nginx-baota-traditional.conf é…ç½®
```

---

## âœ… é…ç½®æ£€æŸ¥æ¸…å•

- [ ] å·²é€‰æ‹©éƒ¨ç½²æ–¹å¼ï¼ˆä¼ ç»Ÿ/Dockerï¼‰
- [ ] å·²å¤åˆ¶å¯¹åº”çš„é…ç½®æ–‡ä»¶
- [ ] å·²ä¿®æ”¹ä»£ç†ç«¯å£ï¼ˆDocker éƒ¨ç½²éœ€è¦ï¼‰
- [ ] å·²ä¿®æ”¹å‰ç«¯è·¯å¾„ï¼ˆä¼ ç»Ÿéƒ¨ç½²éœ€è¦ï¼‰
- [ ] å·²åœ¨å®å¡”é¢æ¿ä¸­åº”ç”¨é…ç½®
- [ ] Nginx é…ç½®æµ‹è¯•é€šè¿‡
- [ ] å·²é‡è½½ Nginx é…ç½®
- [ ] åç«¯ API å¯è®¿é—®
- [ ] å‰ç«¯é¡µé¢å¯è®¿é—®
- [ ] SSL è¯ä¹¦å·²é…ç½®ï¼ˆå¯é€‰ä½†æ¨èï¼‰

---

## ğŸ“ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼š502 Bad Gateway

```bash
# æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ
# ä¼ ç»Ÿéƒ¨ç½²
pm2 status
curl http://localhost:3000/api/health

# Docker éƒ¨ç½²
docker-compose ps
curl http://localhost:8080/api/health
```

### é—®é¢˜ 2ï¼š404 Not Foundï¼ˆå‰ç«¯ï¼‰

```bash
# æ£€æŸ¥å‰ç«¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la /www/wwwroot/minilpa-web/client/dist/index.html

# æ£€æŸ¥ Nginx é…ç½®ä¸­çš„ root è·¯å¾„æ˜¯å¦æ­£ç¡®
nginx -T | grep root
```

### é—®é¢˜ 3ï¼šAPI è¯·æ±‚å¤±è´¥

```bash
# æ£€æŸ¥ä»£ç†é…ç½®
nginx -T | grep -A 10 "location /api"

# æµ‹è¯•åç«¯è¿æ¥
curl http://127.0.0.1:3000/api/health  # ä¼ ç»Ÿéƒ¨ç½²
curl http://127.0.0.1:8080/api/health  # Docker éƒ¨ç½²
```

---

**é€‰æ‹©é€‚åˆæ‚¨çš„éƒ¨ç½²æ–¹å¼ï¼Œç„¶ååº”ç”¨å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼** ğŸš€

