# 🐳 镜像拉取部署指南

## 📋 目录

- [方案概述](#方案概述)
- [优势说明](#优势说明)
- [完整流程](#完整流程)
- [本地构建和推送](#本地构建和推送)
- [服务器拉取和部署](#服务器拉取和部署)
- [镜像仓库配置](#镜像仓库配置)
- [常见问题](#常见问题)
- [维护和更新](#维护和更新)

---

## 🎯 方案概述

**镜像拉取部署**是指：
1. **本地构建** Docker 镜像
2. **推送到** Docker Hub 或国内镜像仓库
3. **服务器拉取**镜像并运行容器

这种方式完美解决了服务器构建时的资源消耗和网络问题。

---

## ✅ 优势说明

### vs 服务器构建方式

| 特性 | 镜像拉取部署 | 服务器构建 |
|------|------------|-----------|
| **构建环境** | ✅ 本地（资源充足） | ❌ 服务器（资源有限） |
| **构建速度** | ✅ 快（3-5分钟） | ❌ 慢（10-30分钟） |
| **服务器资源** | ✅ 低（只运行） | ❌ 高（构建+运行） |
| **网络问题** | ✅ 无（本地网络好） | ❌ 容易卡住 |
| **部署速度** | ✅ 快（拉取即用） | ❌ 慢（需要构建） |
| **版本管理** | ✅ 清晰（tag管理） | ❌ 难以管理 |
| **回滚速度** | ✅ 秒级 | ❌ 需要重建 |
| **预测试** | ✅ 可以测试 | ❌ 无法预测试 |

---

## 🔄 完整流程

```
┌─────────────────┐
│  本地开发环境   │
└────────┬────────┘
         │
         │ 1. 构建镜像
         ▼
┌─────────────────┐
│  Docker 镜像    │
└────────┬────────┘
         │
         │ 2. 推送镜像
         ▼
┌─────────────────┐
│  镜像仓库       │
│ (Docker Hub/    │
│  阿里云/腾讯云) │
└────────┬────────┘
         │
         │ 3. 服务器拉取
         ▼
┌─────────────────┐
│  服务器运行     │
│  (Docker 容器)  │
└─────────────────┘
```

---

## 🏗️ 本地构建和推送

### 前置要求

- ✅ Docker Desktop（本地已安装）
- ✅ Docker Hub 账号（或阿里云/腾讯云账号）
- ✅ 项目代码已克隆到本地

### 步骤 1: 登录镜像仓库

#### Docker Hub

```bash
docker login
# 输入用户名: davidqin1995
# 输入密码: [您的密码]
```

#### 阿里云容器镜像服务

```bash
docker login --username=your-username registry.cn-hangzhou.aliyuncs.com
# 输入密码: [您的密码]
```

### 步骤 2: 构建并推送镜像

#### 方式一：使用脚本（推荐）⭐⭐⭐⭐⭐

```bash
cd /Users/jason/devTools/code/miniplapro/minilpa-web

# 构建并推送（默认 latest 标签）
bash build-and-push.sh

# 或指定版本号
bash build-and-push.sh v1.0.0
```

**脚本会自动完成**：
- ✅ 构建 Docker 镜像
- ✅ 测试镜像（可选）
- ✅ 推送到仓库（latest 和版本标签）

#### 方式二：手动构建

```bash
# 1. 构建镜像
docker build -t davidqin1995/minilpa-web:v1.0.0 .
docker tag davidqin1995/minilpa-web:v1.0.0 davidqin1995/minilpa-web:latest

# 2. 测试镜像（可选）
docker run -d -p 3001:3000 --name minilpa-test davidqin1995/minilpa-web:v1.0.0
curl http://localhost:3001/api/health
docker stop minilpa-test && docker rm minilpa-test

# 3. 推送镜像
docker push davidqin1995/minilpa-web:v1.0.0
docker push davidqin1995/minilpa-web:latest
```

### 步骤 3: 验证推送

```bash
# 查看本地镜像
docker images | grep minilpa-web

# 或在浏览器访问
# https://hub.docker.com/r/davidqin1995/minilpa-web/tags
```

---

## 🚀 服务器拉取和部署

### 前置要求

- ✅ CentOS 7/8、Ubuntu 18.04+ 等 Linux 系统
- ✅ Docker 20.10+ 已安装
- ✅ docker-compose 1.29+ 已安装（或使用 `docker compose`）

### 步骤 1: 安装 Docker（如果未安装）

```bash
# 快速安装 Docker
curl -fsSL https://get.docker.com | bash -

# 启动 Docker
systemctl start docker
systemctl enable docker

# 验证安装
docker --version
docker-compose --version
```

### 步骤 2: 获取项目代码

```bash
# 方式一：Git 克隆（推荐）
cd /www/wwwroot
git clone https://github.com/David-qin1995/miniLPApro.git temp-minilpa
mv temp-minilpa/minilpa-web minilpa-web
rm -rf temp-minilpa

# 方式二：直接下载（如果没有 Git）
cd /www/wwwroot
wget https://github.com/David-qin1995/miniLPApro/archive/main.zip
unzip main.zip
mv miniLPApro-main/minilpa-web minilpa-web
```

### 步骤 3: 进入项目目录

```bash
cd /www/wwwroot/minilpa-web
```

### 步骤 4: 配置环境变量

```bash
# 复制环境变量模板
cp env.esim.haoyiseo.com .env

# 编辑配置（如果需要）
vim .env
```

**重要配置项**：
```bash
# 域名（必须修改）
CORS_ORIGIN=https://esim.haoyiseo.com

# Session 密钥（建议修改为随机字符串）
SESSION_SECRET=your-random-secret-here

# 是否使用模拟数据
USE_MOCK_DATA=true  # true=模拟，false=真实硬件
```

### 步骤 5: 一键部署（推荐）⭐⭐⭐⭐⭐

```bash
# 使用部署脚本（自动拉取并运行）
bash docker-pull-deploy.sh

# 或指定版本
bash docker-pull-deploy.sh v1.0.0
```

**脚本会自动完成**：
- ✅ 检查 Docker 环境
- ✅ 创建数据目录
- ✅ 拉取最新镜像
- ✅ 停止旧容器
- ✅ 启动新容器
- ✅ 健康检查
- ✅ 状态验证

### 步骤 6: 手动部署（可选）

```bash
# 1. 拉取镜像
docker pull davidqin1995/minilpa-web:latest

# 2. 创建必要目录
mkdir -p data logs uploads logs/nginx

# 3. 启动容器
docker-compose -f docker-compose.image.yml up -d

# 4. 查看状态
docker-compose -f docker-compose.image.yml ps

# 5. 查看日志
docker-compose -f docker-compose.image.yml logs -f
```

---

## 🏪 镜像仓库配置

### Docker Hub（推荐）⭐⭐⭐⭐⭐

**优点**：
- ✅ 全球 CDN，访问速度快
- ✅ 免费使用（公开仓库）
- ✅ 使用简单

**配置**：

1. 注册账号：https://hub.docker.com/
2. 创建仓库：
   - 访问：https://hub.docker.com/repositories
   - 点击 "Create Repository"
   - 名称：`minilpa-web`
   - 可见性：Public（免费）
3. 修改 `build-and-push.sh`：
   ```bash
   IMAGE_NAME="davidqin1995/minilpa-web"
   ```
4. 修改 `docker-compose.image.yml`：
   ```yaml
   image: davidqin1995/minilpa-web:latest
   ```

---

### 阿里云容器镜像服务（国内推荐）⭐⭐⭐⭐⭐

**优点**：
- ✅ 国内访问速度快
- ✅ 免费使用（有额度）
- ✅ 支持私有仓库

**配置**：

1. 注册并登录：https://cr.console.aliyun.com/
2. 创建命名空间：
   - 访问：容器镜像服务 → 命名空间
   - 点击 "创建命名空间"
   - 名称：`minilpa`（或您的命名）
3. 创建镜像仓库：
   - 访问：容器镜像服务 → 镜像仓库
   - 点击 "创建镜像仓库"
   - 命名空间：选择刚创建的
   - 仓库名称：`minilpa-web`
   - 仓库类型：公开 或 私有
4. 修改配置文件：

   **build-and-push.sh**：
   ```bash
   IMAGE_NAME="registry.cn-hangzhou.aliyuncs.com/minilpa/minilpa-web"
   ```

   **docker-compose.image.yml**：
   ```yaml
   image: registry.cn-hangzhou.aliyuncs.com/minilpa/minilpa-web:latest
   ```

5. 登录：
   ```bash
   docker login --username=your-username registry.cn-hangzhou.aliyuncs.com
   ```

---

### 腾讯云容器镜像服务

**配置**：

```bash
IMAGE_NAME="ccr.ccs.tencentyun.com/your-namespace/minilpa-web"
```

---

## 📝 详细部署步骤

### 本地环境：构建和推送

#### 步骤 1: 准备项目

```bash
cd /Users/jason/devTools/code/miniplapro/minilpa-web

# 确保代码是最新的
git pull origin main
```

#### 步骤 2: 配置镜像名称

编辑 `build-and-push.sh`：

```bash
# Docker Hub
IMAGE_NAME="davidqin1995/minilpa-web"

# 或阿里云
IMAGE_NAME="registry.cn-hangzhou.aliyuncs.com/minilpa/minilpa-web"
```

#### 步骤 3: 构建并推送

```bash
# 登录（如果未登录）
docker login

# 构建并推送
bash build-and-push.sh v1.0.0
```

**预期输出**：
```
[1/4] 构建 Docker 镜像...
✅ 镜像构建成功

[2/4] 测试镜像...
✅ 镜像测试通过

[3/4] 登录 Docker Hub...
✅ 登录成功

[4/4] 推送镜像到仓库...
✅ 推送成功！
```

---

### 服务器环境：拉取和部署

#### 步骤 1: 准备环境

```bash
# SSH 登录服务器
ssh root@your-server-ip

# 安装 Docker（如果未安装）
curl -fsSL https://get.docker.com | bash -
systemctl start docker
systemctl enable docker
```

#### 步骤 2: 获取项目

```bash
cd /www/wwwroot

# 克隆项目
git clone https://github.com/David-qin1995/miniLPApro.git temp-minilpa
mv temp-minilpa/minilpa-web minilpa-web
rm -rf temp-minilpa

cd minilpa-web
```

#### 步骤 3: 配置环境变量

```bash
# 复制模板
cp env.esim.haoyiseo.com .env

# 检查配置
cat .env | grep -E "CORS_ORIGIN|SESSION_SECRET"
```

#### 步骤 4: 修改镜像配置

编辑 `docker-compose.image.yml`，确保镜像名称正确：

```yaml
services:
  minilpa-web:
    image: davidqin1995/minilpa-web:latest  # 修改为您的镜像名
```

#### 步骤 5: 一键部署

```bash
bash docker-pull-deploy.sh
```

**预期输出**：
```
[1/5] 创建数据目录...
✅ 目录创建完成

[2/5] 更新镜像配置...
✅ 配置更新完成

[3/5] 拉取 Docker 镜像...
✅ 镜像拉取成功

[4/5] 停止旧容器...
✅ 旧容器已停止

[5/5] 启动容器...
✅ 容器启动成功

✅ 后端服务正常
✅ Nginx 代理正常
```

#### 步骤 6: 验证部署

```bash
# 查看容器状态
docker-compose -f docker-compose.image.yml ps

# 应该看到：
# NAME           STATUS    PORTS
# minilpa-web    Up        0.0.0.0:3000->3000/tcp
# minilpa-nginx  Up        0.0.0.0:80->80/tcp

# 测试后端
curl http://localhost:3000/api/health

# 测试 Nginx
curl http://localhost/api/health
```

---

## ⚙️ 配置说明

### docker-compose.image.yml

```yaml
services:
  minilpa-web:
    image: davidqin1995/minilpa-web:latest  # 镜像名称
    ports:
      - "3000:3000"  # 后端端口
    environment:
      - CORS_ORIGIN=https://esim.haoyiseo.com
    volumes:
      - ./data:/app/data        # 数据持久化
      - ./logs:/app/logs        # 日志持久化
      - ./uploads:/app/uploads  # 上传文件持久化
      - ./.env:/app/.env:ro     # 环境变量

  nginx:
    image: nginx:alpine  # 官方 Nginx 镜像
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - minilpa-web
```

### 镜像标签说明

- `latest` - 最新版本（推荐用于生产）
- `v1.0.0` - 具体版本号（用于版本管理）
- `v1.0.0-beta` - 测试版本

---

## 🔧 常见问题

### 问题 1: 镜像拉取失败

**错误**：`Error pulling image: repository not found`

**解决方案**：
```bash
# 1. 检查镜像名称是否正确
cat docker-compose.image.yml | grep image

# 2. 检查镜像是否已推送
# 访问 https://hub.docker.com/r/davidqin1995/minilpa-web

# 3. 如果使用私有仓库，先登录
docker login
```

---

### 问题 2: 容器无法启动

**解决方案**：
```bash
# 查看详细日志
docker-compose -f docker-compose.image.yml logs minilpa-web

# 检查配置
docker-compose -f docker-compose.image.yml config

# 检查端口占用
lsof -i:3000
```

---

### 问题 3: 环境变量不生效

**解决方案**：
```bash
# 1. 检查 .env 文件是否存在
ls -la .env

# 2. 检查配置是否正确
cat .env | grep CORS_ORIGIN

# 3. 重启容器
docker-compose -f docker-compose.image.yml restart minilpa-web
```

---

### 问题 4: 数据丢失

**原因**：数据卷映射不正确

**解决方案**：
```yaml
# 确保 docker-compose.image.yml 中有数据卷映射
volumes:
  - ./data:/app/data        # 数据目录
  - ./logs:/app/logs        # 日志目录
  - ./uploads:/app/uploads  # 上传目录
```

---

## 🔄 维护和更新

### 更新应用

```bash
# 1. 本地构建新版本
cd /Users/jason/devTools/code/miniplapro/minilpa-web
bash build-and-push.sh v1.0.1

# 2. 服务器拉取新版本
ssh root@your-server-ip
cd /www/wwwroot/minilpa-web
bash docker-pull-deploy.sh v1.0.1
```

### 回滚到旧版本

```bash
cd /www/wwwroot/minilpa-web

# 直接指定旧版本号
bash docker-pull-deploy.sh v1.0.0
```

### 查看当前版本

```bash
# 查看镜像标签
docker images | grep minilpa-web

# 查看容器使用的镜像
docker-compose -f docker-compose.image.yml ps
docker inspect minilpa-web | grep Image
```

### 清理旧镜像

```bash
# 删除未使用的镜像
docker image prune -a

# 删除特定镜像的旧版本
docker rmi davidqin1995/minilpa-web:v0.9.0
```

---

## 📊 部署检查清单

### 本地构建阶段

- [ ] Docker Desktop 已安装并运行
- [ ] 已登录镜像仓库（`docker login`）
- [ ] 镜像名称已配置正确
- [ ] 镜像构建成功
- [ ] 镜像测试通过
- [ ] 镜像已推送到仓库

### 服务器部署阶段

- [ ] Docker 已安装（`docker --version`）
- [ ] docker-compose 已安装
- [ ] 项目代码已获取
- [ ] `.env` 文件已配置
- [ ] `CORS_ORIGIN` 已修改为正确域名
- [ ] `SESSION_SECRET` 已修改为随机字符串
- [ ] 镜像名称已配置正确
- [ ] 镜像拉取成功
- [ ] 容器启动成功
- [ ] 后端健康检查通过
- [ ] Nginx 代理正常
- [ ] 域名已解析
- [ ] SSL 证书已配置（可选）

---

## 🎯 快速参考

### 本地构建和推送（一条命令）

```bash
cd /Users/jason/devTools/code/miniplapro/minilpa-web && \
docker login && \
bash build-and-push.sh
```

### 服务器部署（一条命令）

```bash
cd /www/wwwroot/minilpa-web && \
cp env.esim.haoyiseo.com .env && \
bash docker-pull-deploy.sh
```

---

## 📈 性能对比

### 时间对比

| 阶段 | 镜像拉取部署 | 服务器构建 |
|------|------------|-----------|
| **本地构建** | 3-5 分钟 | - |
| **推送镜像** | 1-2 分钟 | - |
| **服务器拉取** | 30 秒 - 2 分钟 | - |
| **服务器构建** | - | 10-30 分钟 |
| **总计** | **5-9 分钟** | **10-30 分钟** |

### 资源对比

| 资源 | 镜像拉取部署 | 服务器构建 |
|------|------------|-----------|
| **服务器 CPU** | 10% (运行) | 100% (构建) |
| **服务器内存** | 512MB | 2GB+ |
| **服务器带宽** | 100MB (拉取) | 500MB+ (npm包) |

---

## ✅ 优势总结

1. ✅ **速度快** - 服务器只拉取，不构建
2. ✅ **资源省** - 不占用服务器构建资源
3. ✅ **网络好** - 本地网络通常更稳定
4. ✅ **易管理** - 版本清晰，回滚简单
5. ✅ **可测试** - 本地可以预测试镜像
6. ✅ **可靠性高** - 避免服务器环境问题

---

## 🎉 总结

**镜像拉取部署方式是最推荐的部署方案！**

- 🚀 **部署速度快**
- 💰 **资源消耗低**
- 🔒 **可靠性高**
- 📦 **版本管理清晰**

**推荐使用！** 🐳✨

---

## 📞 获取帮助

- 📖 详细文档: `镜像部署方案.md`
- 🐳 Docker 指南: `Docker部署指南.md`
- 🔧 故障排查: 查看本文"常见问题"部分

