# 宝塔面板 CentOS 7 部署指南

## 📋 部署路径
```
/www/wwwroot/minilpa
```

## 🚀 快速部署（一键脚本）

### 方法 1: 使用部署脚本（推荐）

在服务器上执行：

```bash
# 1. 下载项目到宝塔目录
cd /www/wwwroot
git clone <your-repository-url> minilpa
cd minilpa

# 2. 运行一键部署脚本
bash scripts/baota-deploy.sh
```

### 方法 2: 手动部署

按照下面的详细步骤操作。

---

## 📦 前置要求

### 1. 安装宝塔面板

如果还没有安装宝塔：

```bash
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh
```

安装完成后记录：
- 面板地址
- 用户名
- 密码

### 2. 安装必要软件

在宝塔面板中安装：

1. **Nginx** (推荐最新版)
2. **PM2 管理器**
3. **Node.js** (v16 或 v18)

安装步骤：
- 登录宝塔面板
- 进入"软件商店"
- 搜索并安装上述软件

---

## 📥 部署步骤

### 步骤 1: 上传项目文件

#### 方式 A: 使用 Git（推荐）

```bash
# SSH 登录服务器
ssh root@your-server-ip

# 进入宝塔目录
cd /www/wwwroot

# 克隆项目
git clone <your-repository-url> minilpa

# 进入项目目录
cd minilpa
```

#### 方式 B: 手动上传

1. 在本地打包项目：
   ```bash
   cd /Users/jason/devTools/code/miniplapro/minilpa-web
   tar -czf minilpa-web.tar.gz .
   ```

2. 使用宝塔面板上传：
   - 进入"文件"管理
   - 导航到 `/www/wwwroot`
   - 创建 `minilpa` 目录
   - 上传 `minilpa-web.tar.gz`
   - 解压文件

### 步骤 2: 安装依赖

```bash
cd /www/wwwroot/minilpa

# 安装后端依赖
npm install --production

# 安装前端依赖
cd client
npm install
cd ..
```

### 步骤 3: 配置环境变量

```bash
cd /www/wwwroot/minilpa

# 创建生产环境配置
cat > .env << 'EOF'
# ========================================
# 生产环境配置
# ========================================

# 服务器配置
PORT=3000
NODE_ENV=production

# 数据库
DB_PATH=./data/db.json

# CORS (修改为您的域名)
CORS_ORIGIN=https://yourdomain.com

# 文件上传
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=10485760

# Session 密钥（重要：修改为随机字符串）
SESSION_SECRET=$(openssl rand -hex 32)

# ========================================
# LPAC 配置（可选）
# ========================================

# 是否使用模拟数据
# true  = 模拟模式（不需要 lpac 和硬件）
# false = 真实模式（需要安装 lpac 和 eUICC 硬件）
USE_MOCK_DATA=true

# APDU 驱动类型
APDU_DRIVER=auto

# lpac 日志级别
LPAC_LOG_LEVEL=warn
EOF

# 生成随机 SESSION_SECRET
SESSION_SECRET=$(openssl rand -hex 32)
sed -i "s/SESSION_SECRET=.*/SESSION_SECRET=$SESSION_SECRET/" .env

echo "✅ 环境变量配置完成"
```

**重要：修改 CORS_ORIGIN**

```bash
# 将 yourdomain.com 替换为您的实际域名
sed -i 's/yourdomain.com/your-actual-domain.com/g' .env
```

### 步骤 4: 构建前端

```bash
cd /www/wwwroot/minilpa

# 构建前端
npm run build

echo "✅ 前端构建完成"
```

### 步骤 5: 设置目录权限

```bash
cd /www/wwwroot/minilpa

# 创建必要的目录
mkdir -p data uploads logs

# 设置权限
chown -R www:www /www/wwwroot/minilpa
chmod -R 755 /www/wwwroot/minilpa
chmod -R 755 data uploads logs

echo "✅ 目录权限设置完成"
```

### 步骤 6: 配置 PM2

#### 方式 A: 使用宝塔 PM2 管理器（推荐）

1. 登录宝塔面板
2. 进入"软件商店" → "PM2 管理器"
3. 点击"添加项目"
4. 填写信息：
   - **项目名称**: `minilpa`
   - **启动文件**: `/www/wwwroot/minilpa/server/index.js`
   - **运行目录**: `/www/wwwroot/minilpa`
   - **端口**: `3000`
   - **Node 版本**: 选择已安装的版本
5. 点击"提交"

#### 方式 B: 命令行配置

```bash
cd /www/wwwroot/minilpa

# 使用 PM2 启动
pm2 start ecosystem.config.js --env production

# 保存 PM2 配置
pm2 save

# 设置开机自启
pm2 startup
# 复制输出的命令并执行

echo "✅ PM2 配置完成"
```

### 步骤 7: 配置 Nginx

#### 方式 A: 使用宝塔面板（推荐）

1. **创建站点**
   - 进入"网站"
   - 点击"添加站点"
   - 域名: `yourdomain.com`
   - 根目录: `/www/wwwroot/minilpa/client/dist`
   - PHP版本: 纯静态
   - 点击"提交"

2. **配置反向代理**
   - 点击站点名称 → "设置"
   - 选择"反向代理"
   - 点击"添加反向代理"
   - 配置如下：
     ```
     代理名称: minilpa-api
     目标URL: http://127.0.0.1:3000
     发送域名: $host
     ```
   - 点击"保存"

3. **添加静态文件规则**
   - 进入"配置文件"
   - 在 `server` 块中添加：

```nginx
# 前端静态文件
location / {
    root /www/wwwroot/minilpa/client/dist;
    try_files $uri $uri/ /index.html;
    index index.html;
}

# API 反向代理
location /api {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
}

# 上传文件访问
location /uploads {
    proxy_pass http://127.0.0.1:3000;
}

# 静态资源缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Gzip 压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
```

4. **保存并重载 Nginx**

#### 方式 B: 手动配置 Nginx

```bash
# 创建 Nginx 配置文件
cat > /www/server/panel/vhost/nginx/minilpa.conf << 'EOF'
server {
    listen 80;
    server_name yourdomain.com;
    
    # 日志
    access_log /www/wwwroot/minilpa/logs/nginx-access.log;
    error_log /www/wwwroot/minilpa/logs/nginx-error.log;
    
    # 最大上传大小
    client_max_body_size 10M;
    
    # 前端静态文件
    location / {
        root /www/wwwroot/minilpa/client/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
    }
    
    # API 反向代理
    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # 上传文件访问
    location /uploads {
        proxy_pass http://127.0.0.1:3000;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
}
EOF

# 测试配置
nginx -t

# 重载 Nginx
nginx -s reload

echo "✅ Nginx 配置完成"
```

**注意：将 `yourdomain.com` 替换为您的实际域名**

### 步骤 8: 配置防火墙

```bash
# 开放必要端口
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --reload

# 或在宝塔面板中：
# 安全 → 添加端口规则 → 开放 80 和 443
```

### 步骤 9: 配置 SSL（推荐）

在宝塔面板中：

1. 进入站点设置 → "SSL"
2. 选择 "Let's Encrypt" 免费证书
3. 填写邮箱
4. 点击"申请"
5. 开启"强制HTTPS"

---

## ✅ 验证部署

### 1. 检查 PM2 状态

```bash
pm2 status

# 应该看到 minilpa 进程在运行
```

### 2. 检查后端 API

```bash
curl http://localhost:3000/api/health

# 应该返回: {"status":"ok","timestamp":"..."}
```

### 3. 检查 Nginx

```bash
curl http://yourdomain.com

# 应该返回 HTML 内容
```

### 4. 浏览器访问

打开浏览器访问：`http://yourdomain.com` 或 `https://yourdomain.com`

---

## 🔄 更新部署

```bash
cd /www/wwwroot/minilpa

# 拉取最新代码
git pull origin main

# 安装依赖
npm install
cd client && npm install && cd ..

# 重新构建前端
npm run build

# 重启 PM2
pm2 restart minilpa

echo "✅ 更新完成"
```

---

## 📊 监控和维护

### 查看日志

```bash
# PM2 日志
pm2 logs minilpa

# Nginx 日志
tail -f /www/wwwroot/minilpa/logs/nginx-access.log
tail -f /www/wwwroot/minilpa/logs/nginx-error.log

# 应用日志
tail -f /www/wwwroot/minilpa/logs/pm2-out.log
tail -f /www/wwwroot/minilpa/logs/pm2-error.log
```

### 重启服务

```bash
# 重启 PM2
pm2 restart minilpa

# 重启 Nginx
nginx -s reload

# 或在宝塔面板中操作
```

### 备份数据

```bash
cd /www/wwwroot/minilpa

# 手动备份
tar -czf ~/minilpa-backup-$(date +%Y%m%d).tar.gz data/ uploads/

# 或使用自动备份脚本
bash scripts/backup.sh
```

---

## ❌ 故障排查

### 问题 1: PM2 无法启动

```bash
# 查看错误日志
pm2 logs minilpa --err

# 检查端口占用
lsof -i:3000

# 检查环境变量
cat .env
```

### 问题 2: Nginx 502 错误

```bash
# 检查后端是否运行
pm2 status
curl http://localhost:3000/api/health

# 检查 Nginx 配置
nginx -t

# 查看 Nginx 错误日志
tail -50 /www/wwwroot/minilpa/logs/nginx-error.log
```

### 问题 3: 前端页面空白

```bash
# 检查前端是否正确构建
ls -la /www/wwwroot/minilpa/client/dist

# 重新构建
cd /www/wwwroot/minilpa
npm run build

# 检查 Nginx 配置的 root 路径
```

### 问题 4: 权限问题

```bash
# 重新设置权限
chown -R www:www /www/wwwroot/minilpa
chmod -R 755 /www/wwwroot/minilpa
```

---

## 🔒 安全建议

1. **修改默认端口**
   - 修改宝塔面板默认端口
   - 修改 SSH 默认端口

2. **配置防火墙**
   - 只开放必要端口（80, 443）
   - 限制 SSH 访问 IP

3. **定期更新**
   ```bash
   yum update -y
   ```

4. **备份数据**
   - 使用宝塔定时任务
   - 每天自动备份数据库和文件

5. **监控日志**
   - 定期检查异常访问
   - 配置日志告警

---

## 📞 获取帮助

如遇问题：
1. 查看日志文件
2. 参考 [常见问题](../docs/quick-start.md)
3. 提交 Issue

---

**部署完成！祝运行顺利！** 🎉

