╔═══════════════════════════════════════════════════════════════╗
║                                                               ║
║          🚀 MiniLPA Web - 宝塔部署快速指南                   ║
║          部署路径: /www/wwwroot/minilpa                      ║
║                                                               ║
╚═══════════════════════════════════════════════════════════════╝

## 📋 前提条件

✅ CentOS 7 服务器
✅ 已安装宝塔面板
✅ 宝塔面板中已安装:
   - Nginx (推荐最新版)
   - PM2 管理器
   - Node.js (v16 或 v18)

---

## 🚀 方式一：一键部署（推荐）

### 在服务器上执行：

```bash
# 1. 进入宝塔目录
cd /www/wwwroot

# 2. 上传项目（方式任选其一）

# 方式 A: 使用 Git
git clone <your-repository-url> minilpa

# 方式 B: 手动上传并解压
# （在宝塔面板上传 minilpa-web.tar.gz 到 /www/wwwroot/minilpa）

# 3. 进入项目目录
cd minilpa

# 4. 运行一键部署脚本
bash scripts/baota-deploy.sh
```

### 部署完成！

脚本会自动完成：
✅ 安装依赖
✅ 配置环境变量
✅ 构建前端
✅ 设置权限
✅ 配置 PM2
✅ 配置 Nginx
✅ 启动服务

---

## 🛠️ 方式二：手动部署

详见：宝塔部署指南.md

---

## ⚙️ 重要配置

### 1. 修改域名

```bash
# 编辑环境变量
vim /www/wwwroot/minilpa/.env

# 修改这一行：
CORS_ORIGIN=https://your-actual-domain.com
```

### 2. 修改 Nginx 配置

```bash
# 编辑 Nginx 配置
vim /www/server/panel/vhost/nginx/minilpa.conf

# 修改 server_name：
server_name your-actual-domain.com;

# 重载 Nginx
nginx -s reload
```

### 3. 配置 SSL（可选但推荐）

在宝塔面板中：
1. 进入"网站" → 找到您的站点
2. 点击"设置" → "SSL"
3. 选择 "Let's Encrypt"
4. 填写邮箱并申请证书
5. 开启"强制HTTPS"

---

## ✅ 验证部署

### 1. 检查服务状态

```bash
pm2 status
# 应该看到 minilpa 进程在运行
```

### 2. 测试后端 API

```bash
curl http://localhost:3000/api/health
# 应该返回: {"status":"ok",...}
```

### 3. 浏览器访问

打开浏览器访问：http://your-domain.com

---

## 📊 常用命令

```bash
# 查看应用状态
pm2 status

# 查看实时日志
pm2 logs minilpa

# 重启应用
pm2 restart minilpa

# 停止应用
pm2 stop minilpa

# 重启 Nginx
nginx -s reload
```

---

## 🔄 更新应用

```bash
cd /www/wwwroot/minilpa

# 拉取最新代码
git pull

# 安装依赖
npm install
cd client && npm install && cd ..

# 重新构建
npm run build

# 重启服务
pm2 restart minilpa
```

---

## 📂 目录结构

```
/www/wwwroot/minilpa/
├── client/
│   └── dist/          # 前端构建产物（Nginx 访问）
├── server/
│   └── index.js       # 后端入口（PM2 运行）
├── data/              # 数据库文件
├── uploads/           # 上传文件
├── logs/              # 日志文件
├── .env               # 环境变量（重要）
└── ecosystem.config.js # PM2 配置
```

---

## ❌ 常见问题

### 问题1: PM2 无法启动

```bash
# 查看日志
pm2 logs minilpa --err

# 检查端口
lsof -i:3000

# 手动启动测试
node server/index.js
```

### 问题2: Nginx 502 错误

原因：后端未运行

```bash
# 检查后端
pm2 status
pm2 restart minilpa

# 测试后端
curl http://localhost:3000/api/health
```

### 问题3: 前端页面空白

原因：前端未正确构建

```bash
# 重新构建
cd /www/wwwroot/minilpa
npm run build

# 检查文件
ls -la client/dist/
```

### 问题4: 权限错误

```bash
# 重新设置权限
chown -R www:www /www/wwwroot/minilpa
chmod -R 755 /www/wwwroot/minilpa
```

---

## 🔒 安全建议

1. ✅ 修改 .env 中的 SESSION_SECRET
2. ✅ 配置 SSL 证书（HTTPS）
3. ✅ 定期备份数据（data/ 和 uploads/）
4. ✅ 配置防火墙规则
5. ✅ 定期更新系统和软件

---

## 📞 获取帮助

📖 详细文档: 宝塔部署指南.md
🐛 问题反馈: 提交 Issue
💬 交流讨论: [社区/群组]

---

## 🎉 部署检查清单

部署完成后，请确认：

□ PM2 进程正常运行
□ 后端 API 正常响应
□ 前端页面可以访问
□ 已修改域名配置
□ 已配置 SSL 证书
□ 防火墙已开放端口
□ 数据目录权限正确

---

**一切就绪！开始使用 MiniLPA Web！** 🚀

═══════════════════════════════════════════════════════════════

